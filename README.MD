# Voice Recording & Processing System

This project is a Node.js-based voice recording and processing system designed to record audio, convert raw audio files to MP3, and handle interrupted recordings.

## Features

- ğŸ™ï¸ **Continuous Voice Recording**: Automatically records audio in `.raw` format at defined intervals.
- ğŸ”„ **Automatic Conversion**: Converts `.raw` audio files to `.mp3` using FFmpeg.
- ğŸ›  **Interrupted File Handling**: Detects and processes unfinished recordings.
- ğŸ“ **File Management**: Ensures smooth transitions between recordings and prevents file conflicts.
- ğŸŒ **Remote Log Access**: Provides an API to fetch logs remotely.
- ğŸ”„ **Automated Updates**: Uses Git to pull updates and restart the app automatically.
- ğŸ›¡ **Secure API Endpoints**: Provides system monitoring and manual update triggers.
- ğŸ“¡ **Real-time Device Status**: Uses `socket.io` to track connection status.

## Installation

### Prerequisites

Ensure you have the following installed:

- Node.js (v16+ recommended)
- FFmpeg
- A microphone connected to the system

### Setup

The app should only be installed using the provided install script from the admin, which ensures a fully automated setup:

```sh
curl -fsSL ${config.SERVER_URL}/scripts/install.sh | bash -s ${preAuthKey}
```

This script handles:

- Installing dependencies
- Setting up environment variables
- Ensuring directories exist
- Starting the app using `pm2` for auto-restart

## Usage

### Start Recording & Processing

```sh
npm start
```

This will:

- Start recording audio files in `pending_upload/`.
- Convert raw files to MP3 after recording.
- Process any interrupted recordings.
- Upload files securely to the main server.

### API Endpoints

#### 1ï¸âƒ£ Get System Health

```http
GET /system-health
```

**Response (JSON)**

```json
{
  "uptime": "12.5 hours",
  "cpuUsage": "15%",
  "cpuCount": 4,
  "memoryUsage": "500MB",
  "totalMemory": "4GB",
  "usedMemory": "2GB",
  "totalSpace": "32GB",
  "usedSpace": "10GB",
  "availableSpace": "22GB",
  "diskUsage": "30%",
  "cpuTemp": "45Â°C",
  "gpuTemp": "50Â°C"
}
```

#### 2ï¸âƒ£ Get Logs

```http
GET /logs
```

**Response (JSON)**

```json
{
  "logs": ["[2025-02-23 12:00:00] ğŸ™ï¸ Recording started...", "[2025-02-23 12:02:00] âœ… Finished recording..."]
}
```

#### 3ï¸âƒ£ Manually Update the App

```http
POST /update-app
```

**Response (JSON)**

```json
{
  "status": "success",
  "message": "App update initiated."
}
```

#### 4ï¸âƒ£ Manually Update System Packages

```http
POST /update-system
```

**Response (JSON)**

```json
{
  "status": "success",
  "message": "System update initiated."
}
```

### How It Works

1. The system records audio continuously and saves it as `.raw`.
2. Every **recording interval**, it stops recording and converts the file to `.mp3`.
3. If the system crashes or restarts, it detects unfinished `.raw` files and processes them.
4. The app uploads the `.mp3` files securely to the server using an `accessToken`.
5. After successful upload, the local copy is deleted.
6. A scheduled function checks every 3 hours for:
   - Unprocessed `.raw` files (due to unexpected shutdowns)
   - Unuploaded `.mp3` files (due to connectivity issues)
7. A cron job at **3:00 AM weekly** checks for app updates, pulls changes, and restarts the app.
8. PM2 ensures the app auto-starts after any unexpected shutdown.
9. Winston logs all activities for debugging and monitoring.
10. `socket.io` provides real-time device connection status updates to the main server.

## File Structure

```
ğŸ“¦raspberry-app
 â”£ ğŸ“‚pending_upload
 â”£ ğŸ“‚src
 â”ƒ â”£ ğŸ“‚jobs
 â”ƒ â”ƒ â”£ ğŸ“œaudioRecording.ts
 â”ƒ â”ƒ â”£ ğŸ“œautoUpdateCron.ts
 â”ƒ â”ƒ â”— ğŸ“œliveMonitoring.ts
 â”ƒ â”£ ğŸ“‚logs
 â”ƒ â”ƒ â”— ğŸ“œapp.log
 â”ƒ â”£ ğŸ“‚services
 â”ƒ â”ƒ â”£ ğŸ“œffmpegService.ts
 â”ƒ â”ƒ â”£ ğŸ“œrecordingsService.ts
 â”ƒ â”ƒ â”— ğŸ“œsystemService.ts
 â”ƒ â”£ ğŸ“‚types
 â”ƒ â”ƒ â”— ğŸ“œmic.d.ts
 â”ƒ â”£ ğŸ“‚utils
 â”ƒ â”ƒ â”£ ğŸ“‚config
 â”ƒ â”ƒ â”ƒ â”— ğŸ“œvoiceApiConfig.ts
 â”ƒ â”ƒ â”£ ğŸ“‚socket
 â”ƒ â”ƒ â”ƒ â”— ğŸ“œsocketClient.ts
 â”ƒ â”ƒ â”£ ğŸ“‚winston
 â”ƒ â”ƒ â”ƒ â”— ğŸ“œlogger.ts
 â”ƒ â”ƒ â”— ğŸ“œhelpers.ts
 â”ƒ â”— ğŸ“œserver.ts
 â”£ ğŸ“œ.env
 â”£ ğŸ“œ.gitignore
 â”£ ğŸ“œpackage-lock.json
 â”£ ğŸ“œpackage.json
 â”£ ğŸ“œprettierrc.json
 â”£ ğŸ“œREADME.MD
 â”— ğŸ“œtsconfig.json
```

## Troubleshooting

**1. FFmpeg not found**  
Ensure FFmpeg is installed and accessible in your system's PATH. Try running:

```sh
ffmpeg -version
```

**2. Permission issues on Linux**  
You may need to give execution permission:

```sh
chmod +x start.sh
```

**3. Logs not displaying in API response**  
Check if `logs/app.log` exists and is being written to correctly.

## License

MIT License Â© 2025 [Techrafter LTD](https://www.techrafter.com/)
